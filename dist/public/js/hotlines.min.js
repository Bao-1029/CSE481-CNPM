import{createElement,mandatory,sendData,getData,getClosest,childrenMatches,filterElements}from"./helpers.js";const btn_add=document.querySelector(".main__add"),table=document.querySelector(".main__table tbody");function logout(){fetch("user/logout",{method:"POST"}).then(response=>{302==response.status&&window.location.replace("login")}).catch(err=>console.log("Request failed",err))}function getHotlines(){return getData("hotline/all",{method:"GET"}).catch(err=>console.log("Request failed",err))}function sendHotline(action=mandatory(),method=mandatory(),formData=mandatory(),isReturn=!1){return isReturn?sendData(`hotline/${action}`,{method:method,body:formData}):getData(`hotline/${action}`,{method:method,body:formData})}function addHotline(){const new_row=createTableRow({id:void 0,name:"",phone_number:""}),btn_edit=new_row.querySelector(".main__icon-edit");table.insertAdjacentElement("afterbegin",new_row),btn_edit.click()}function saveEdit(event){const{parent:parent,td_name:td_name,td_phone:td_phone,in_name:in_name,in_phone:in_phone}=event.target,action=parent.querySelectorAll('[role="data action"]'),id_row=parent.id_row,val_name=in_name.value,val_phone=in_phone.value;let data=new FormData;data.set("name",val_name),data.set("phone_number",val_phone),null==parent.id_row?parent.id_row=sendHotline("add","POST",data,!0):(data.set("id",id_row),sendHotline("edit","POST",data)),td_name.textContent=val_name,td_phone.textContent=val_phone,action.forEach(a=>a.remove()),parent.classList.remove("edit")}function cancelEdit(event){const parent=event.target.parent;if(null==parent.id_row)return void parent.remove();const{td_name:td_name,td_phone:td_phone}=event.target,btns=parent.querySelectorAll('[role="data action"]');td_name.querySelector("input").remove(),td_phone.querySelector("input").remove(),btns.forEach(btn=>btn.remove()),parent.classList.remove("edit")}function editHotline(event){const tr=getClosest(event.target,"tr"),action=childrenMatches(tr,'[role="actions"]')[0],{td_name:td_name,td_phone:td_phone}=event.target,data={name:td_name.textContent,phone_number:td_phone.textContent},{name:name,phone_number:phone_number}=data,fragment=new DocumentFragment,in_name=createElement("input",{value:name}),in_phone=createElement("input",{value:phone_number}),btn_save=createElement("button",{class:"main__edit",text:"Lưu",role:"data action",props:{parent:tr,td_name:td_name,td_phone:td_phone,in_name:in_name,in_phone:in_phone},events:{click:saveEdit.bind(this)}}),btn_cancel=createElement("button",{class:"main__delete",text:"Hủy",role:"data action",props:{parent:tr,td_name:td_name,td_phone:td_phone},events:{click:cancelEdit.bind(this)}});tr.classList.add("edit"),fragment.appendChild(in_name),td_name.appendChild(fragment),fragment.appendChild(in_phone),td_phone.appendChild(fragment),fragment.appendChild(btn_save),fragment.appendChild(btn_cancel),action.appendChild(fragment)}function deleteHotline(event){const parent=getClosest(event.target,"tr"),id_row=parent.id_row;if(null==id_row)return void parent.remove();const{td_name:td_name}=event.target,hostpital=td_name.textContent.trim();let data=new FormData;data.set("id",id_row),confirm(`Xóa dữ liệu về bệnh viện ${hostpital}`)&&sendHotline("remove","POST",data)}function createTableRow(data){const{id:id,name:name,phone_number:phone_number}=data,elem_name=createElement("td",{"data-type":"name",text:name}),elem_phone=createElement("td",{"data-type":"phone",text:phone_number}),btn_edit=createElement("button",{class:"main__icon-edit",role:"row action",props:{td_name:elem_name,td_phone:elem_phone},events:{click:editHotline.bind(this)}}),btn_delete=createElement("button",{class:"main__icon-delete",role:"row action",props:{td_name:elem_name},events:{click:deleteHotline.bind(this)}}),elem_action=createElement("td",{role:"actions",nodes:[btn_edit,btn_delete]}),tr=createElement("tr",{props:{id_row:id},nodes:[elem_name,elem_phone,elem_action]});return tr}async function initView(){const data=await getHotlines(),fragment=new DocumentFragment;data.forEach(d=>{const row=createTableRow(d);fragment.appendChild(row)}),document.querySelector(".main__icon-loading-hpl").remove(),table.appendChild(fragment),btn_add.onclick=addHotline}btn_add.onclick=()=>alert("Dữ liệu đang được tải, xin chờ chút!"),table.insertAdjacentHTML("beforeend",'<div class="main__icon-loading-hpl">\n        <div class="main__loading-hpl"></div>\n        <span class="main__text-loading-hpl">Đang tải...</span>\n    </div>'),document.getElementById("search").addEventListener("keyup",filterElements.bind(this,table,"tr")),document.getElementById("btn-logout").addEventListener("click",logout),document.getElementById("item-logout").addEventListener("click",logout),initView();